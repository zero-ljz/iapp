<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>定时网络任务程序</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            margin-bottom: 20px;
        }

        form {
            margin-bottom: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .button-group {
            display: inline-block;
            vertical-align: middle;
        }

        .button-group button {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>定时网络任务程序</h1>

    <form method="get" id="form1" action="/add_task">
        <label for="url">URL：</label>
        <input type="text" id="url" name="url" required><br>

        <label for="start_time">开始时间：</label>
        <input type="datetime-local" id="start_time" name="start_time" required>
        <input type="hidden" id="formatted_start_time" name="formatted_start_time"><br>
    
        <label for="end_time">结束时间：</label>
        <input type="datetime-local" id="end_time" name="end_time" required>
        <input type="hidden" id="formatted_end_time" name="formatted_end_time"><br>

        <label for="days">重复周期：</label>
        <input type="number" id="days" name="days" min="0" placeholder="天" style="width: 60px;">
        <input type="number" id="hours" name="hours" min="0" placeholder="时" style="width: 60px;">
        <input type="number" id="minutes" name="minutes" min="0" placeholder="分" style="width: 60px;">
        <input type="number" id="seconds" name="seconds" min="0" placeholder="秒" style="width: 60px;"><br>

        <input type="submit" value="添加任务">
    </form>

    <table>
        <thead>
            <tr>
                <th>URL</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>重复周期</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            % for i, task in enumerate(tasks):
            <tr>
                <td>{{ task['url'] }}</td>
                <td>{{ task['start_time'] }}</td>
                <td>{{ task['end_time'] }}</td>
                <td>{{ task['interval'] }} 秒</td>
                <td class="button-group">
                    <button onclick="cancelTask({{ i }})">取消</button>
                    % if task['paused']:
                    <button onclick="resumeTask({{ i }})">恢复</button>
                    % else:
                    <button onclick="pauseTask({{ i }})">暂停</button>
                    % end
                </td>
            </tr>
            % end
        </tbody>
    </table>

    <script>

  // 获取表单和日期时间输入元素
  var form = document.getElementById('form1');
  var startDateTimeInput = document.getElementById('start_time');
  var formattedStartDateTimeInput = document.getElementById('formatted_start_time');
  var endDateTimeInput = document.getElementById('end_time');
  var formattedEndDateTimeInput = document.getElementById('formatted_end_time');

  // 在表单提交之前处理日期时间值
  form.addEventListener('submit', function(event) {
    // 获取用户输入的日期时间值
    var startDateTimeValue = startDateTimeInput.value;
    var endDateTimeValue = endDateTimeInput.value;

    // 格式化日期时间值为指定格式
    var formattedStartDateTime = formatDateTime(startDateTimeValue);
    var formattedEndDateTime = formatDateTime(endDateTimeValue);

    // 将格式化后的值设置为隐藏字段的值
    formattedStartDateTimeInput.value = formattedStartDateTime;
    formattedEndDateTimeInput.value = formattedEndDateTime;
  });

  // 格式化日期时间值为指定格式的函数
  function formatDateTime(dateTimeValue) {
    var dateTime = new Date(dateTimeValue);
    var year = padZero(dateTime.getFullYear(), 3);
    var month = padZero(dateTime.getMonth() + 1, 2);
    var day = padZero(dateTime.getDate(), 2);
    var hours = padZero(dateTime.getHours(), 2);
    var minutes = padZero(dateTime.getMinutes(), 2);
    var seconds = padZero(dateTime.getSeconds(), 2);

    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
  }

  // 辅助函数：在数字不足指定位数时补零
  function padZero(number, length) {
    var paddedNumber = String(number);
    while (paddedNumber.length < length) {
      paddedNumber = '0' + paddedNumber;
    }
    return paddedNumber;
  }












        function cancelTask(index) {
            fetch(`/cancel_task/${index}`)
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                });
        }

        function pauseTask(index) {
            fetch(`/pause_task/${index}`)
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                });
        }

        function resumeTask(index) {
            fetch(`/resume_task/${index}`)
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                });
        }
    </script>
</body>
</html>
